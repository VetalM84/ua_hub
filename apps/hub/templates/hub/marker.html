{% extends 'base.html' %}
{% load i18n %}
{% load cache %}
{% load custom_filters %}
{% load static %}
{% block title %}
    <title>{% translate "Mark #" %} {{ marker.pk }}</title>

    <link href="{% static "css/markers.css" %}" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
{% endblock %}

{% block body %}
    <div class="container">
        <section class="mx-auto my-5 col-md-6">
            <div class="card testimonial-card mt-2 mb-3">
                <div class="card-up aqua-gradient"></div>
                <div class="avatar mx-auto white">
                    <img src="{{ MEDIA_URL }}{{ marker.owner.avatar }}" class="rounded-circle img-fluid" alt="image">
                </div>
                <div class="card-body text-center position-relative">
                    <!-- likes -->
                    <div class="position-absolute" style="right: 16px; top: -50px;">
                        {% csrf_token %}
                        <span id="like_count_{{ marker.pk }}">{{ marker.likes_count }}</span>
                        {% if request.user.is_authenticated %}
                            <button class="btn btn-link bi bi-heart-fill p-1" data-id="{{ marker.pk }}"
                                    value="{{ marker.pk }}"></button>
                        {% else %}
                            <i class="link-primary bi bi-heart-fill p-1"></i>
                        {% endif %}
                    </div>
                    <!-- likes END -->
                    <h4 class="card-title font-weight-bold">{{ marker.owner.get_full_name }}</h4>
                    <div class="d-flex" style="font-size: small;">
                        <div class="flex-fill text-end me-2">
                            {% translate "Category" %}: {{ marker.category.name }}
                        </div>
                        <div class="flex-fill text-start ms-2">
                            {{ marker.created_at|to_user_tz_short }}
                        </div>
                    </div>

                    <!-- likes -->
                    <div class="mb-3">
                        {% csrf_token %}
                        <span id="like_count_{{ marker.pk }}">{{ marker.likes_count }}</span>
                        {% if request.user.is_authenticated %}
                            <button class="btn btn-link bi bi-heart" data-id="{{ marker.pk }}"
                                    value="{{ marker.pk }}"></button>
                        {% else %}
                            <i class="bi bi-heart"></i>
                        {% endif %}
                    </div>
                    <!-- likes END -->

                    <p><i class="bi bi-quote"></i>{{ marker.comment }}</p>
                    <hr>

                </div>
            </div>
        </section>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            $(document).on('click', '.bi-heart-fill', function (e) {
                var id = $(this).attr('data-id');
                e.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: '{% url "like" %}',
                    data: {
                        marker_id: id,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                        action: 'post'
                    },
                    success: function (json) {
                        document.getElementById("like_count_" + id).innerHTML = json['result']
                    },
                    error: function (xhr, errmsg, err) {

                    }
                });
            })
        })
    </script>
{% endblock %}